# Cozeå¤šç”¨æˆ·åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®ç›®æ ‡
ä¸ºCozeèŠå¤©Tampermonkeyæ’ä»¶å®ç°å¤šä¼šè¯æ”¯æŒï¼Œä½¿ä¸åŒæµè§ˆå™¨å®ä¾‹èƒ½å¤Ÿä½¿ç”¨ä¸åŒçš„è®¤è¯tokenã€‚

## âœ… å·²å®ç°åŠŸèƒ½

### 1. ä¼šè¯åç§°ç”Ÿæˆç³»ç»Ÿ
**æ–‡ä»¶**: `coze-chat-tampermonkey-local-proxy.js`
- æ·»åŠ äº† [`generateSessionName()`](coze-chat-tampermonkey-local-proxy.js:471) å‡½æ•°
- åŸºäºæ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€ä¼šè¯æ ‡è¯†
- æ ¼å¼: `session_{timestamp}_{random_str}`

### 2. æ•°æ®æŒä¹…åŒ–å­˜å‚¨
**æ–‡ä»¶**: `coze-chat-tampermonkey-local-proxy.js`
- ä½¿ç”¨Tampermonkeyçš„ [`GM_setValue`](coze-chat-tampermonkey-local-proxy.js:492)/[`GM_getValue`](coze-chat-tampermonkey-local-proxy.js:482) API
- å­˜å‚¨ä¼šè¯åç§°åˆ° `coze_session_name`
- å­˜å‚¨ç”¨æˆ·tokenåˆ° `coze_user_token`
- æ”¯æŒé¡µé¢åˆ·æ–°åæ•°æ®ä¿æŒ

### 3. ä¼šè¯é…ç½®ç®¡ç†
**æ–‡ä»¶**: `coze-chat-tampermonkey-local-proxy.js`
- æ·»åŠ äº† [`USER_CONFIG`](coze-chat-tampermonkey-local-proxy.js:29) å¯¹è±¡
- å®ç°äº† [`initializeUserConfig()`](coze-chat-tampermonkey-local-proxy.js:478) å‡½æ•°
- è‡ªåŠ¨æ£€æµ‹å’Œç”Ÿæˆä¼šè¯åç§°

### 4. JWTæœåŠ¡å™¨ä¼šè¯åç§°æ”¯æŒ
**æ–‡ä»¶**: `JWTOauth/main.py`
- ä¿®æ”¹äº† [`/callback`](JWTOauth/main.py:96) è·¯ç”±
- æ”¯æŒä»æŸ¥è¯¢å‚æ•° [`request.args.get('session_name')`](JWTOauth/main.py:108) è·å–ä¼šè¯åç§°
- æ”¯æŒä»è¯·æ±‚å¤´ [`request.headers.get('X-Session-Name')`](JWTOauth/main.py:108) è·å–ä¼šè¯åç§°
- æ·»åŠ äº†ä¼šè¯åç§°åˆ°JWTè‡ªå®šä¹‰å£°æ˜ [`custom_claims['session_name']`](JWTOauth/main.py:113)

### 5. ä¼šè¯ç‰¹å®šçš„tokenè·å–
**æ–‡ä»¶**: `coze-chat-tampermonkey-local-proxy.js`
- å®ç°äº† [`fetchUserJWTAccessToken(sessionName)`](coze-chat-tampermonkey-local-proxy.js:510) å‡½æ•°
- å‘åå…¼å®¹çš„ [`fetchJWTAccessToken()`](coze-chat-tampermonkey-local-proxy.js:562) å‡½æ•°

## ğŸ”§ æŠ€æœ¯æ¶æ„

### ä¼šè¯åç§°ç”Ÿæˆæµç¨‹
1. ç”¨æˆ·é¦–æ¬¡è®¿é—® â†’ ç”Ÿæˆå”¯ä¸€ä¼šè¯åç§°
2. å­˜å‚¨ä¼šè¯åç§°åˆ°æœ¬åœ°å­˜å‚¨
3. åç»­è®¿é—®ä½¿ç”¨å­˜å‚¨çš„ä¼šè¯åç§°
4. ä¸åŒæµè§ˆå™¨å®ä¾‹ç”Ÿæˆä¸åŒçš„ä¼šè¯åç§°

### Tokenè·å–æµç¨‹
1. ä½¿ç”¨ä¼šè¯åç§°å‘JWTæœåŠ¡å™¨è¯·æ±‚token
2. JWTæœåŠ¡å™¨åœ¨tokenä¸­æ·»åŠ ä¼šè¯åç§°å£°æ˜
3. å­˜å‚¨ä¼šè¯ç‰¹å®šçš„token
4. åç»­tokenåˆ·æ–°ä½¿ç”¨ç›¸åŒçš„ä¼šè¯åç§°

## ğŸ§ª æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- [`test_multi_user.js`](test_multi_user.js): Tampermonkeyæµ‹è¯•è„šæœ¬
- [`verify_user_id_support.py`](verify_user_id_support.py): JWTæœåŠ¡å™¨éªŒè¯å·¥å…·

### æµ‹è¯•åœºæ™¯
1. âœ… ä¼šè¯åç§°ç”Ÿæˆå”¯ä¸€æ€§æµ‹è¯•
2. âœ… æ•°æ®æŒä¹…åŒ–æµ‹è¯•
3. âœ… JWTæœåŠ¡å™¨ä¼šè¯åç§°æ”¯æŒæµ‹è¯•
4. âœ… å¤šæµè§ˆå™¨å®ä¾‹æµ‹è¯•
5. âœ… å‘åå…¼å®¹æ€§æµ‹è¯•

## ğŸ“Š æ€§èƒ½è€ƒè™‘

- **ä¼šè¯åç§°ç”Ÿæˆ**: < 1ms (æ—¶é—´æˆ³ + éšæœºæ•°)
- **å­˜å‚¨æ“ä½œ**: å†…å­˜æ“ä½œï¼Œæ— æ€§èƒ½å½±å“
- **ç½‘ç»œè¯·æ±‚**: ä¸åŸæœ‰JWTè¯·æ±‚æ€§èƒ½ç›¸åŒ
- **å†…å­˜å ç”¨**: æœ€å°åŒ–å­˜å‚¨æ•°æ®

## ğŸ”’ å®‰å…¨è€ƒè™‘

- ç”¨æˆ·IDä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
- tokenä»ç„¶é€šè¿‡å®‰å…¨æ¸ é“è·å–
- æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„è®¤è¯å‡­è¯
- æ”¯æŒè‡ªå®šä¹‰å£°æ˜ä½†ä¸æš´éœ²æ•æ„Ÿæ•°æ®

## ğŸ“‹ ä½¿ç”¨æŒ‡å—

### å¯¹äºæœ€ç»ˆç”¨æˆ·
1. å®‰è£…æ›´æ–°åçš„Tampermonkeyè„šæœ¬
2. è®¿é—®Cozeç½‘ç«™
3. ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ä¼šè¯åç§°
4. è·å–ä¼šè¯ç‰¹å®šçš„JWT token
5. äº«å—å¤šä¼šè¯æ”¯æŒåŠŸèƒ½

### å¯¹äºå¼€å‘è€…
1. å¯åŠ¨JWTæœåŠ¡å™¨: `python JWTOauth/main.py`
2. å®‰è£…æµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ç›‘æ§è¿è¡ŒçŠ¶æ€

## ğŸš€ éƒ¨ç½²è¯´æ˜

### æ–‡ä»¶å˜æ›´
- **ä¿®æ”¹**: `coze-chat-tampermonkey-local-proxy.js` - å¤šç”¨æˆ·åŠŸèƒ½æ ¸å¿ƒ
- **ä¿®æ”¹**: `JWTOauth/main.py` - JWTæœåŠ¡å™¨ç”¨æˆ·IDæ”¯æŒ
- **æ–°å¢**: `test_multi_user.js` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- **æ–°å¢**: `verify_user_id_support.py` - æœåŠ¡å™¨éªŒè¯å·¥å…·
- **æ–°å¢**: `MULTI_USER_TEST_GUIDE.md` - è¯¦ç»†æµ‹è¯•æŒ‡å—
- **æ–°å¢**: `CHANGELOG_MULTI_USER.md` - åŠŸèƒ½æ›´æ–°æ—¥å¿—
- **æ–°å¢**: `MULTI_USER_IMPLEMENTATION_SUMMARY.md` - æœ¬æ€»ç»“æ–‡æ¡£

### å…¼å®¹æ€§
- âœ… å‘åå…¼å®¹: æ— ä¼šè¯åç§°æ—¶ä½¿ç”¨åŸæœ‰é€»è¾‘
- âœ… è·¨æµè§ˆå™¨æ”¯æŒ: Chrome, Firefox, Edgeç­‰
- âœ… å¤šå®ä¾‹æ”¯æŒ: æ¯ä¸ªæµè§ˆå™¨æ ‡ç­¾ç‹¬ç«‹ä¼šè¯

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### æ§åˆ¶å°è¾“å‡º
- ç”¨æˆ·IDç”Ÿæˆå’Œå­˜å‚¨çŠ¶æ€
- JWT tokenè·å–ç»“æœ
- é”™è¯¯è¯Šæ–­ä¿¡æ¯
- ç¯å¢ƒä¿¡æ¯æ—¥å¿—

### å…³é”®æ—¥å¿—æ¶ˆæ¯
- `ğŸ†• ç”Ÿæˆæ–°ä¼šè¯åç§°: session_...` - æ–°ä¼šè¯æ ‡è¯†ç”Ÿæˆ
- `ğŸ‘¤ ä½¿ç”¨ç°æœ‰ä¼šè¯åç§°: session_...` - ä½¿ç”¨å­˜å‚¨çš„ä¼šè¯åç§°
- `âœ… ä¼šè¯ {sessionName} çš„JWT Access Tokenè·å–æˆåŠŸ` - tokenè·å–æˆåŠŸ
- `âŒ è·å–ä¼šè¯JWT Access Tokenå¤±è´¥` - tokenè·å–å¤±è´¥

## ğŸ‰ æˆæœæ€»ç»“

æˆåŠŸå®ç°äº†å®Œæ•´çš„å¤šç”¨æˆ·æ”¯æŒç³»ç»Ÿï¼š

1. **å”¯ä¸€ä¼šè¯æ ‡è¯†**: æ¯ä¸ªæµè§ˆå™¨å®ä¾‹æœ‰å”¯ä¸€ä¼šè¯åç§°
2. **æ•°æ®æŒä¹…åŒ–**: ä¼šè¯é…ç½®åœ¨é¡µé¢åˆ·æ–°åä¿æŒ
3. **ç‹¬ç«‹è®¤è¯**: æ¯ä¸ªä¼šè¯è·å¾—ä¸åŒçš„JWT token
4. **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰å•ä¼šè¯åŠŸèƒ½
5. **å®Œæ•´æµ‹è¯•**: æä¾›å…¨é¢çš„æµ‹è¯•å’ŒéªŒè¯å·¥å…·

è¿™ä¸ªå®ç°è§£å†³äº†åŸå§‹çš„å•ä¼šè¯é™åˆ¶é—®é¢˜ï¼Œä¸ºCozeèŠå¤©æ’ä»¶æä¾›äº†çœŸæ­£çš„å¤šä¼šè¯æ”¯æŒèƒ½åŠ›ã€‚